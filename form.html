<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta viewport="width=device-width, initial-scale=1.0" />
<title>Heat Map Wizz&auml;rd</title>
<script type="text/javascript" src="javascripts/polyfill.js"></script>
<script type="text/javascript" src="javascripts/md5.js"></script>
<script src="//code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="javascripts/jquery.csv.min.js" type="text/javascript"></script>
<link type="text/css" href="stylesheets/hmw.css" rel="stylesheet" />
<style type="text/css">
#wiz-map	{height:600px; width:100%; max-width:800px; margin:1em auto;}
</style>
</head>
<body>
<header id="hdr">
	<h1 class="c">Heat Map Wizz&auml;rd</h1>
	<nav id="nav"><ul>
		<li><a href="https://github.com/HeatMapWizard/Capstone">Repo</a></li>
	</ul></nav>
</header>
<main id="main">
	<form class="cf" id="wiz">
		<label><!-- select id="fn-choose" required="required"><optgroup label="Select file"></optgroup></select --><input type="file" id="fn-choose" required="required" accept="text/csv" /><span>Choose file</span></label>
		<label><input type="checkbox" id="use-lbl" /><span>I have labeled columns</span></label>
		<label class="w50"><select id="col-lat" required="required"><optgroup label="Select column"></optgroup></select><span>Latitude column</span></label>
		<label class="w50"><select id="col-lng" required="required"><optgroup label="Select column"></optgroup></select><span>Longitude column</span></label>
		<label><select id="col-wt" required="required"><optgroup label="Select column"></optgroup></select><span>Weight column</span></label>
		<label><select id="center" required="required"><optgroup label="Select location"></optgroup></select><span>Center map at&hellip;</span></label>
		<!-- label><select id="map-type" required="required"><optgroup label="Select type"></optgroup></select><span>Map type</span></label -->
		<button type="submit" id="upd-map" class="btn btn-primary btn-sub">Update!</button>
	</form>
	<div id="loaded-file"></div>
	<div id="wiz-map"></div>
</main>
<footer id="ftr"><p class="r copy">&copy; Heat Map Wizz&auml;rd</footer>
<script type="text/javascript">/* <![CDATA[ */

//https://maps.googleapis.com/maps/api/geocode/json?address=1600+Amphitheatre+Parkway,+Mountain+View,+CA&key=AIzaSyBtpAb_QeWDYxt8wGyU90NWyb2hnst-src


var map=null, mid="wiz-map", heats={}, res={};
var cfg = {
	"initZoom":13,
	"maxSize":1024*1024*2
};
var zInit = 13;
var types = {
	"ROADMAP":{"label":"Road map"},
	"SATELLITE":{"label":"Satellite"},
	"HYBRID":{"label":"Hybrid"}
};
var centers = {
	"ny-cp":{"label":"Central Park","lat":40.7828647,"lng":-73.9675438},
	"ny-ts":{"label":"Times Square","lat":40.758895,"lng":-73.9873197},
	"us-dc":{"label":"Washington, DC","lat":38.899265,"lng":-77.154656}
}, cid = "ny-cp";

var scales = [];
(function(s){
	function _sc(n) {
		return {
			"label":n,
			"val":(n/10)
		}
	}
	for (var i=0; i<10; ++i)
		s[i] = _sc(i+1);
	console.log(s);
})(scales);



function initMap() {
	var m = document.getElementById(mid);
	if (m) {
		//var c = {lat: 39.8282, lng: -98.5795};
		var c = new google.maps.LatLng(centers[cid]["lat"], centers[cid]["lng"]);
		if (!(map instanceof google.maps.Map)) {
			map = new google.maps.Map(m, {
				zoom: zInit, center: c,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			});
			google.maps.event.addListener(map, 'zoom_changed', function() {
				var zoomLevel = map.getZoom()-1; if (zoomLevel<0) zoomLevel = 0;
				//console.log(zoomLevel);
				// each zoom level changes zoom by a factor of 2
				var radius = (1<<zoomLevel)/25;
				for (var k in heats) if (heats[k].set) heats[k].set('radius', radius*scales[0].val);
			});
		}
		console.log("HMW","init id="+mid+", c="+cid);//,map);
		clearHeats(heats);
		map.setCenter(c);
	}
	else {
		console.log("couldn't init map");
	}
}

function clearHeats(d) {
	var i;
	if ((i=d.length)) {
		while (--i>-1) {
			if (d[i]&&d[i].getMap()) d[i].setMap(null);
		}
	}
	d.length = 0;
	console.log("heat layers cleared");
}
function addHeat(m,i,d) {
	//console.log(d);
	var h = new google.maps.visualization.HeatmapLayer({
		maxIntensity:1
	});
	if (d&&d["coordinates"]) h.setData(d["coordinates"]), console.log(d["coordinates"]);
	h.set('radius', 25);
	heats[i] = (h);
	console.log("heat layer added, now "+heats.length+" layer(s)");
}
function activateHeat(m,i) {
	console.log("activating heat layer "+i);
	try {
		if (heats&&heats[i]) heats[i].setMap(m?m:null);//, console.log(heats[i]);
	} catch (e) {
		console.log("HMW","couldn't activate heat layer "+i,e);
	}
	console.log("heat layer "+i+" map",heats[i].getMap());
}

function updateMap(m, d) {
	alert("Updating map!");
	console.log("HMW","TODO","update map with layers="+d.length);
	clearHeats(heats);
	if (m) {
		for (var i in d) {
			console.log("update",i);
			addHeat(m,i,d[i]);
			activateHeat(m,i);
		}
		console.log("map updated");
	}
}

function hasNone(id) {
	return ["col-wt"].indexOf(id)>-1;
}

function rplcOpt(id,a,h) {
	var txt = "";
	for (var i=0; i<a.length; ++i) {
		txt += "<option value='"+i+"'>"+(h?a[i]:(i+1))+"</option>";
	}
	var e = document.getElementById(id);
	if (e) {
		var grp = e.childNodes[0];
		if (hasNone(id)) txt = "<option value='-1'>&lt;none&gt;</option>"+txt;
		//console.log(e.childNodes[0]);
		grp.innerHTML = txt;
	}
}
function rplcOptObj(id,a,p) {
	var txt = "";
	for (var i in a) {
		txt += "<option value='"+i+"'>"+(a[i][p])+"</option>";
	}
	var e = document.getElementById(id);
	if (e) {
		var grp = e.childNodes[0];
		//console.log(e.childNodes[0]);
		grp.innerHTML = txt;
	}
}

var testFiles = {
	"starbucks":{"label":"Starbucks","file":"starbucks.csv"},
	"jfk":{"label":"JFK flights","file":"Flight_2015.csv"},
	"schools":{"label":"Schools","file":"modified_data.csv"},
	"zip":{"label":"Zip codes","file":"zipcode.csv"}
};

$(function(){
	//rplcOptObj("fn-choose",testFiles,"label");
	rplcOptObj("center",centers,"label");
	//rplcOptObj("map-type",types,"label");
	var r = [], a = [], hdr = [];
	var _h = null;
	function _on_load(d) {
		alert("got csv size "+d.length);
		_h = md5(d);
		if (!res[_h]) {
			r.length = 0;
			hdr.length = 0;	// TODO: ALLOW MULTI-LAYER!!!
			r = $.csv.toObjects(d);
			a = $.csv.toArrays(d);
			hdr = a[0];
			res[_h] = {
				"header":hdr,
				"converted":a,
				"associative":r
			};
			//console.log(r);
		}
		$("#use-lbl").change();
		//alert("File loaded");
	}
	function _load_them(f) {
		if (!f.length) alert("No files loaded!");
		else {
			var d = document.getElementById("loaded-file");
			if (d) {
				d.innerHTML = "<h4>Layers</h4>";
				for (var i=0, fs=f.length; i<fs; ++i) {
					_load_it(f[i]);
					//_load_it(f[fn]["file"]);
				}
			}
		}
	}
	function _load_it(f) {
		console.log("HMW:_load_it",f);
		if (f.size>cfg.maxSize) {
			alert("File '"+f.name+"' too large!");
			return false;
		}
		var url = window.URL.createObjectURL(f);
		var d = document.getElementById("loaded-file");
		if (d) {
			// TODO: STYLIZE LIST+ACTIONS!!!
			d.innerHTML +=
				//"<code>TODO: convert to CSV, create heat layer</code><br/>"+
				"<em>"+f.name+" : "+f.size+" byte(s) ("+f.type+")</em><br/>"+
				"<em>"+url+"</em>";
			var fr = new FileReader();
			fr.onload = (function(el){return function(e){
				//el.innerHTML += "<pre>"+e.target.result+"</pre>";
				_on_load(e.target.result);
			}})(d);
			fr.readAsBinaryString(f);
		}
		//$.get(url+"?ts="+(+(new Date())), _on_load);
		window.URL.revokeObjectURL(url);
		return true;
	}
	$("#fn-choose").change(function(){
		var f = $(this).val();
		return _load_them(this.files);
	});
	$("#use-lbl").change(function(){
		var use_lbl = document.getElementById("use-lbl").checked;
		rplcOpt("col-label",res[_h]["header"],use_lbl);
		rplcOpt("col-lat",res[_h]["header"],use_lbl);
		rplcOpt("col-lng",res[_h]["header"],use_lbl);
		rplcOpt("col-wt",res[_h]["header"],use_lbl);
		alert("You may select your latitude, longitude, and weight columns now!");
	});
	$("#wiz").submit(function(e){
		e.preventDefault();
		if (!google) console.log("GAPI not loaded yet!");
		else if (!google.maps) console.log("GMAPI not loaded yet!");
		else if (!a.length) alert("Dataset not loaded yet!");
		else {
			var d = [];
			var lat = $("#col-lat").val(),
				lng = $("#col-lng").val(),
				wt = $("#col-wt").val(),
				c = $("#center").val(),
				t = $("#map-type").val();
			//var _lat, _lng, _wt;
			var i = document.getElementById("use-lbl").checked?1:0;
			console.log("HMW","LAT-col="+lat,"LNG-col="+lng,"WT-col="+wt,"labeled="+i);
			for (i; i<a.length; ++i) {
				d.push(
					{
						location: new google.maps.LatLng(+a[i][lat], +a[i][lng]),
						weight: wt>-1?+a[i][wt]:1.0
					}
				);
			}
			res[_h]["coordinates"] = (d);
			if (map) {
				map.setMapTypeId(t);
				map.setCenter(new google.maps.LatLng(centers[c]["lat"], centers[c]["lng"]));
				if (res[_h]) updateMap(map, res);
				//console.log("upd done");
			}
			//console.log("else done");
		}
		//console.log("sub done");
	});
	//$("#fn-choose").change();
});
/* ]]> */</script>
<script async defer src="//maps.googleapis.com/maps/api/js?key=AIzaSyBtpAb_QeWDYxt8wGyU90NWyb2hnst-src&amp;libraries=visualization&amp;callback=initMap">
</script>
</body>
</html>
